<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Proxy Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #004400; }
        .error { background: #440000; color: #ff0000; }
        .info { background: #000044; color: #00ffff; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #00ff00;
            border: none;
            border-radius: 5px;
            margin: 5px;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç CORS Proxy Test</h1>

    <div id="environment" class="status info">
        Detecting environment...
    </div>

    <div id="proxy" class="status info">
        Checking CORS proxy...
    </div>

    <button onclick="testProxy()">Test CORS Proxy</button>
    <button onclick="testDirect()">Test Direct ESPN API (will fail)</button>
    <button onclick="location.reload()">Refresh</button>

    <h2>Response:</h2>
    <pre id="response">Click "Test CORS Proxy" to start...</pre>

    <h2>Console Logs:</h2>
    <pre id="logs"></pre>

    <script>
        const logs = [];
        const originalLog = console.log;
        const originalError = console.error;

        console.log = function(...args) {
            logs.push('[LOG] ' + args.join(' '));
            document.getElementById('logs').textContent = logs.join('\n');
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            logs.push('[ERROR] ' + args.join(' '));
            document.getElementById('logs').textContent = logs.join('\n');
            originalError.apply(console, args);
        };

        // Detect environment
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isVercel = window.location.hostname.includes('vercel.app') || window.location.hostname === 'playbyplay.football';
        const isAzure = window.location.hostname.includes('azurestaticapps.net');
        const isNetlify = window.location.hostname.includes('netlify.app');

        let CORS_PROXY;
        let environment;
        if (isLocalhost) {
            CORS_PROXY = 'http://localhost:8001/?url=';
            environment = 'localhost';
        } else if (isVercel || isAzure) {
            CORS_PROXY = '/api/cors-proxy?url=';
            environment = isVercel ? 'vercel' : 'azure';
        } else if (isNetlify) {
            CORS_PROXY = '/.netlify/functions/cors-proxy?url=';
            environment = 'netlify';
        } else {
            CORS_PROXY = '/api/cors-proxy?url=';
            environment = 'custom-domain';
        }

        document.getElementById('environment').innerHTML = `
            <strong>Environment:</strong> ${environment}<br>
            <strong>Hostname:</strong> ${window.location.hostname}<br>
            <strong>CORS Proxy:</strong> ${CORS_PROXY}
        `;
        document.getElementById('environment').className = 'status success';

        console.log('Environment:', environment);
        console.log('CORS Proxy:', CORS_PROXY);

        async function testProxy() {
            const responseEl = document.getElementById('response');
            const proxyEl = document.getElementById('proxy');

            proxyEl.textContent = 'üîÑ Testing CORS proxy...';
            proxyEl.className = 'status info';
            responseEl.textContent = 'Loading...';

            try {
                const espnUrl = 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard';
                const proxyUrl = CORS_PROXY + encodeURIComponent(espnUrl);

                console.log('Testing proxy URL:', proxyUrl);

                const response = await fetch(proxyUrl);
                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Data received:', data);

                proxyEl.innerHTML = `‚úÖ CORS Proxy Working!<br>Status: ${response.status}`;
                proxyEl.className = 'status success';
                responseEl.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                console.error('Test failed:', error);
                proxyEl.innerHTML = `‚ùå CORS Proxy Failed!<br>Error: ${error.message}`;
                proxyEl.className = 'status error';
                responseEl.textContent = 'Error: ' + error.message;
            }
        }

        async function testDirect() {
            const responseEl = document.getElementById('response');
            responseEl.textContent = 'Testing direct ESPN API (this should fail with CORS error)...';

            try {
                const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard');
                const data = await response.json();
                responseEl.textContent = 'Unexpected success:\n' + JSON.stringify(data, null, 2);
            } catch (error) {
                responseEl.textContent = 'Expected CORS error:\n' + error.message;
                console.log('Expected CORS error:', error);
            }
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Auto-testing proxy...');
                testProxy();
            }, 1000);
        });
    </script>
</body>
</html>
